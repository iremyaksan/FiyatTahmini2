name: Configure Ngrok on EC2

on:
  workflow_dispatch:

jobs:
  configure-ngrok:
    runs-on: ubuntu-latest
    
    steps:
    - name: Configure Ngrok on EC2
      env:
        SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        echo "$SSH_KEY" > /tmp/key.pem
        chmod 600 /tmp/key.pem
        
        ssh -o StrictHostKeyChecking=no -i /tmp/key.pem $EC2_USER@$EC2_HOST << 'ENDSSH'
          echo "=== Configuring Ngrok ==="
          
          # Configure authtoken
          ngrok config add-authtoken 379np0NAuwaqIzuGFuJPEzm9fnG_37HgB5MprTL329GmNRj57
          
          # Kill any existing ngrok processes
          pkill ngrok || true
          
          # Start ngrok in background
          nohup ngrok http 8082 > /tmp/ngrok.log 2>&1 &
          
          # Wait for ngrok to start
          echo "Waiting for ngrok to start..."
          sleep 10
          
          # Get HTTPS URL
          echo "=== Ngrok HTTPS URL ==="
          curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url' || echo "Failed to get URL"
          
          # Show ngrok process
          echo "=== Ngrok Process ==="
          ps aux | grep ngrok | grep -v grep
        ENDSSH
        
        rm -f /tmp/key.pem
