name: Configure Ngrok on EC2

on:
  workflow_dispatch:

jobs:
  configure-ngrok:
    runs-on: ubuntu-latest
    
    steps:
    - name: Configure Ngrok on EC2
      env:
        SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        echo "$SSH_KEY" > /tmp/key.pem
        chmod 600 /tmp/key.pem
        
        ssh -o StrictHostKeyChecking=no -i /tmp/key.pem $EC2_USER@$EC2_HOST << 'ENDSSH'
          echo "=== Configuring Ngrok ==="
          
          # Configure authtoken
          ngrok config add-authtoken 379np0NAuwaqIzuGFuJPEzm9fnG_37HgB5MprTL329GmNRj57
          
          # Start and enable ngrok service
          sudo systemctl start ngrok
          sudo systemctl enable ngrok
          
          # Wait for ngrok to start
          sleep 5
          
          # Get HTTPS URL
          echo "=== Ngrok HTTPS URL ==="
          curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1
          
          # Check service status
          echo "=== Ngrok Service Status ==="
          sudo systemctl status ngrok --no-pager
        ENDSSH
        
        rm -f /tmp/key.pem
